<script>
    console.log('=== Page Loaded ===');
    
    const CONFIG = {
        instanceUrl: 'https://zayo--dev.sandbox.my.salesforce.com',
        clientId: '3MVG9u5bid8bKNSJuHRl8Wv7D2P_lUn3aBy0T3.j91TqxL6J1nPbttbYlj3fgtC2qKmw_G821FMQRdpuSYzRl',
        redirectUri: 'https://nancy-jemimah.github.io/TestRepository/',
        lightningOutAppId: '1UsVZ000000018z0AA'
    };

    const statusDiv = document.getElementById('status');
    const loginBtn = document.getElementById('loginBtn');
    const appContainer = document.getElementById('appContainer');

    function updateStatus(message, type = 'info') {
        statusDiv.textContent = message;
        statusDiv.className = '';
        if (type === 'error') statusDiv.classList.add('error');
        if (type === 'success') statusDiv.classList.add('success');
        console.log(`[${type.toUpperCase()}]`, message);
    }

    function showLoading(message) {
        statusDiv.innerHTML = `<span class="spinner"></span> ${message}`;
    }

    loginBtn.addEventListener('click', function() {
        console.log('=== Starting OAuth ===');
        showLoading('Redirecting to Salesforce...');
        
        const authUrl = `${CONFIG.instanceUrl}/services/oauth2/authorize?` +
            `client_id=${encodeURIComponent(CONFIG.clientId)}&` +
            `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&` +
            `response_type=token&` +
            `scope=full`;
        
        window.location.href = authUrl;
    });

    async function handleOAuthCallback() {
        const hash = window.location.hash.substring(1);
        
        if (!hash) {
            console.log('No OAuth callback');
            return;
        }
        
        console.log('=== OAuth Callback Detected ===');
        loginBtn.style.display = 'none';
        
        const params = new URLSearchParams(hash);
        const accessToken = params.get('access_token');
        
        if (!accessToken) {
            updateStatus('❌ No access token', 'error');
            return;
        }
        
        console.log('✓ Access token received');
        showLoading('Getting frontdoor URL...');
        
        try {
            const response = await fetch(
                `${CONFIG.instanceUrl}/services/oauth2/lightningoutsingleaccess`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        access_token: accessToken,
                        lightning_out_app_id: CONFIG.lightningOutAppId
                    })
                }
            );
            
            console.log('Frontdoor response:', response.status);
            
            if (!response.ok) {
                const text = await response.text();
                console.error('Frontdoor error:', text);
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('✓ Frontdoor URL received');
            
            updateStatus('✓ Authenticated', 'success');
            showLoading('Loading flow...');
            
            // Create Lightning Out application
            appContainer.innerHTML = `
                <lightning-out-application 
                    id="loApp"
                    components="c-flow-wrapper"
                    frontdoor-url="${data.frontdoor_uri}">
                </lightning-out-application>
                <c-flow-wrapper flow-api-name="Field_Ops_Request"></c-flow-wrapper>
            `;
            
            console.log('✓ Lightning Out elements created');
            console.log('appContainer HTML:', appContainer.innerHTML);
            
            // Check multiple times for iframe
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                checkCount++;
                console.log(`Checking for iframe (attempt ${checkCount})...`);
                
                const iframe = document.querySelector('lightning-out-application iframe');
                const loApp = document.getElementById('loApp');
                const flowWrapper = document.querySelector('c-flow-wrapper');
                
                console.log('- loApp element:', loApp);
                console.log('- c-flow-wrapper element:', flowWrapper);
                console.log('- iframe element:', iframe);
                
                if (iframe) {
                    console.log('✓ Found iframe!');
                    console.log('Iframe current height:', iframe.style.height);
                    iframe.style.height = '1200px';
                    iframe.style.width = '100%';
                    console.log('Iframe height set to 1200px');
                    clearInterval(checkInterval);
                    updateStatus('✅ Flow loaded!', 'success');
                } else if (checkCount >= 20) {
                    console.error('❌ Iframe not found after 20 attempts (10 seconds)');
                    console.log('This likely means the component is not rendering');
                    clearInterval(checkInterval);
                    updateStatus('❌ Component failed to load', 'error');
                }
            }, 500);
            
            const loApp = document.getElementById('loApp');
            
            if (loApp) {
                loApp.addEventListener('lo.application.ready', function(e) {
                    console.log('✓✓✓ lo.application.ready event fired!', e);
                    updateStatus('✅ Application ready!', 'success');
                });
                
                loApp.addEventListener('lo.application.error', function(e) {
                    console.error('❌ lo.application.error:', e.detail);
                    updateStatus(`❌ Error: ${e.detail.message}`, 'error');
                });
            }
            
        } catch (error) {
            console.error('Error:', error);
            updateStatus(`❌ ${error.message}`, 'error');
        }
    }

    console.log('=== Page Ready ===');
    handleOAuthCallback();
</script>
